<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ti·∫øn ƒê·ªô - Version A.15 (Chrome/Safari Only)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root { --primary: #4361ee; --success: #2ecc71; --danger: #ef476f; --warning: #ffd166; --dark: #1e293b; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 5px 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box; }
        
        /* C·∫¢NH B√ÅO TR√åNH DUY·ªÜT */
        #browserGuard {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; z-index: 9999; flex-direction: column; align-items: center; justify-content: center; text-align: center;
            padding: 20px;
        }

        /* B·∫¢O M·∫¨T NG·∫¶M */
        body.is-readonly #adminForm, 
        body.is-readonly .col-8 button, 
        body.is-readonly .btn-sm { 
            pointer-events: none !important; 
            filter: grayscale(1) opacity(0.3) !important; 
            cursor: not-allowed !important;
        }
        body.is-readonly input { pointer-events: none !important; background-color: #f1f5f9 !important; }

        .container { max-width: 1450px; margin: auto; width: 100%; display: flex; flex-direction: column; height: 100%; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 15px; border-radius: 8px; margin-bottom: 5px; flex-shrink: 0; }
        
        #adminForm { 
            display: grid; 
            grid-template-columns: 1.5fr 1fr 0.8fr 0.8fr 0.4fr 1.5fr 1.5fr 0.6fr; 
            gap: 5px; background: #fff; padding: 8px; border-radius: 8px; margin-bottom: 5px; 
        }
        
        #taskName { width: calc(100% + 80px); }
        #taskDept { margin-left: 80px; }
        #startDate { width: calc(100% - 96px); margin-left: 80px; }
        #deadline { width: calc(100% - 15px); }
        #iterCount { margin-left: -18px; }
        #taskRef { margin-left: -20px; }

        input { height: 30px; padding: 0 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; outline: none; }
        .btn-add { height: 30px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; transition: 0.3s; }
        
        .main-content { background: white; border-radius: 8px; flex-grow: 1; overflow-y: auto; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border-bottom: 1px solid #f8fafc; font-size: 12px; height: 42px; padding: 0 10px; white-space: nowrap; }
        th { background: #f8fafc; color: #64748b; position: sticky; top: 0; text-align: left; z-index: 10; text-transform: uppercase; font-size: 11px; }

        .col-stt { width: 45px; text-align: center; }
        .col-1 { width: 28%; }
        .col-2 { width: 9%; } 
        .col-3 { width: 9%; }
        .col-4 { width: 5%; text-align: center; }
        .col-5 { width: 14%; } 
        .col-6 { width: 8%; }
        .col-7 { width: 10%; }
        .col-8 { width: 14%; text-align: right; overflow: visible !important; }

        .col-2, .col-3, .col-4, .col-5 { transform: translateX(45px); }

        .overdue-row { background-color: #fff1f2 !important; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; color: #fff; font-weight: 700; display: inline-block; min-width: 80px; text-align: center; }
        .btn-sm { width: 28px; height: 28px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-left: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; transition: 0.2s; }
        
        .btn-sm:disabled { opacity: 0.2; cursor: not-allowed; filter: grayscale(1); }
        .progress-bg { width: 100%; background: #eee; height: 6px; border-radius: 3px; }
        .progress-fill { height: 100%; border-radius: 3px; transition: 0.3s; }
        #deviceStatus { font-size: 10px; color: #94a3b8; margin-left: 10px; }
    </style>
</head>
<body class="is-readonly">

<div id="browserGuard">
    <div>
        <i class="fa-brands fa-chrome" style="font-size: 60px; color: #4285F4; margin: 10px;"></i>
        <i class="fa-brands fa-safari" style="font-size: 60px; color: #00AEEF; margin: 10px;"></i>
    </div>
    <h2 style="color: var(--dark)">Tr√¨nh duy·ªát kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£</h2>
    <p style="color: #64748b; line-height: 1.6;">ƒê·ªÉ ƒë·∫£m b·∫£o an to√†n d·ªØ li·ªáu, vui l√≤ng s·ª≠ d·ª•ng:<br>
    <b style="color: var(--primary)">Google Chrome</b> ho·∫∑c <b style="color: var(--primary)">Safari</b></p>
</div>

<div class="container">
    <div class="top-bar">
        <div class="brand">üìã <b>QU·∫¢N L√ù TI·∫æN ƒê·ªò - V.15</b> <span id="syncStatus" style="font-size: 11px; margin-left:10px; color: var(--primary); font-weight: normal;"></span> <span id="deviceStatus"></span></div>
        <div class="auth-btns">
            <button style="background:#334155; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:default; font-size:11px;">Admin Control</button>
        </div>
    </div>

    <div id="adminForm">
        <input type="text" id="taskName" placeholder="T√™n vi·ªác...">
        <input type="text" id="taskDept" placeholder="B·ªô ph·∫≠n...">
        <input type="date" id="startDate" title="B·∫Øt ƒë·∫ßu">
        <input type="date" id="deadline" title="H·∫°n ch√≥t">
        <input type="number" id="iterCount" value="1" title="L·∫ßn">
        <input type="text" id="taskRef" placeholder="Tham chi·∫øu...">
        <input type="text" id="emailRecipient" placeholder="Email nh·∫≠n...">
        <button class="btn-add" onclick="addTask()">TH√äM</button>
    </div>

    <div class="main-content">
        <table>
            <thead>
                <tr>
                    <th class="col-stt">STT</th>
                    <th class="col-1">Vi·ªác / B·ªô ph·∫≠n</th>
                    <th class="col-2">B·∫Øt ƒë·∫ßu</th>
                    <th class="col-3">H·∫°n ch√≥t</th>
                    <th class="col-4">L·∫ßn</th>
                    <th class="col-5">Tham chi·∫øu</th>
                    <th class="col-6">Ti·∫øn ƒë·ªô</th>
                    <th class="col-7">Tr·∫°ng th√°i</th>
                    <th class="col-8">Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>
    </div>
</div>

<script>
    const EMAILJS_PUBLIC_KEY = 'K29qboR4uZpsyMu0Z';
    const EMAILJS_SERVICE_ID = 'service_s73hjtp'; 
    const EMAILJS_TEMPLATE_ID = 'template_0cgys98';
    const BIN_ID = '6965ac34d0ea881f4067e559'; 
    const READ_KEY = '$2a$10$E020cSPDeHQd0G9ytrUj3u1YSFJN0d9sP3X0B38kOk.sZoVNqZn8K';
    const MASTER_KEY = '$2a$10$zN5MZaAsLugTkyNZA0ZHMu7CKiAktxDFCw1IGFEi4H46JOocrLTSy';
    const URL = "https://api.jsonbin.io/v3/b/" + BIN_ID;

    emailjs.init(EMAILJS_PUBLIC_KEY);
    let allTasks = [];
    let whitelist = [];

    // --- MODULE KI·ªÇM TRA TR√åNH DUY·ªÜT ---
    function checkBrowser() {
        const ua = navigator.userAgent;
        const isChrome = /Chrome/.test(ua) && /Google Inc/.test(navigator.vendor);
        const isSafari = /Safari/.test(ua) && /Apple Computer/.test(navigator.vendor) && !/Chrome/.test(ua);
        
        if (!isChrome && !isSafari) {
            document.getElementById('browserGuard').style.display = 'flex';
        }
    }

    // --- ID C·ªê ƒê·ªäNH (LOCALSTORAGE) ---
    function getDeviceID() {
        let savedID = localStorage.getItem('my_unique_device_id');
        if (savedID) return savedID;
        const newID = "ID-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
        localStorage.setItem('my_unique_device_id', newID);
        return newID;
    }
    const currentID = getDeviceID();

    window.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.code === 'KeyR') {
            e.preventDefault();
            if (whitelist[0] === currentID) {
                const pass = prompt("H·ªÜ TH·ªêNG RESET - NH·∫¨P M·∫¨T M√É:");
                if (pass === "Hadmin123456$") {
                    if (confirm("X√≥a Whitelist?")) {
                        whitelist = [];
                        silentSave().then(() => location.reload());
                    }
                }
            }
        }
    });

    async function fetchData() {
        checkBrowser(); // Ch·∫°y ki·ªÉm tra tr√¨nh duy·ªát
        try {
            const res = await fetch(URL, { headers: { 'X-Access-Key': READ_KEY, 'X-Bin-Meta': false } });
            const data = await res.json();
            allTasks = data.tasks || [];
            whitelist = data.whitelist || [];
            await silentSecurityCheck();
            await processAutoChecks();
            await autoCheckAndSendEmails();
            renderTable();
        } catch (e) { console.error("L·ªói d·ªØ li·ªáu"); }
    }

    async function autoCheckAndSendEmails() {
        const now = new Date(); now.setHours(0,0,0,0);
        let hasMailSent = false;
        for (let t of allTasks) {
            const d = new Date(t.end); d.setHours(0,0,0,0);
            if (t.status !== "Ho√†n th√†nh" && d <= now && t.email && !t.alertSent) {
                const success = await sendEmailCore(t);
                if (success) { t.alertSent = true; hasMailSent = true; }
            }
        }
        if (hasMailSent) await silentSave();
    }

    async function silentSecurityCheck() {
        const statusEl = document.getElementById('deviceStatus');
        if (whitelist.includes(currentID)) {
            document.body.classList.remove('is-readonly');
        } else if (whitelist.length < 2) {
            whitelist.push(currentID);
            await silentSave();
            document.body.classList.remove('is-readonly');
        } else {
            statusEl.innerText = "(Ch·∫ø ƒë·ªô xem)";
            document.body.classList.add('is-readonly');
        }
    }

    async function processAutoChecks() {
        const now = new Date(); now.setHours(0,0,0,0);
        let hasChange = false;
        for (let t of allTasks) {
            const d = new Date(t.end); d.setHours(0,0,0,0);
            if (d < now && t.status === "ƒêang l√†m") { t.status = "Qu√° h·∫°n"; hasChange = true; }
        }
        if (hasChange) await silentSave();
    }

    async function silentSave() {
        await fetch(URL, { 
            method: 'PUT', 
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY }, 
            body: JSON.stringify({ tasks: allTasks, whitelist: whitelist }) 
        });
    }

    async function saveData() {
        document.getElementById('syncStatus').innerText = "ƒêang l∆∞u...";
        await silentSave();
        document.getElementById('syncStatus').innerText = "ƒê√£ ƒë·ªìng b·ªô";
        setTimeout(() => document.getElementById('syncStatus').innerText = "", 2000);
        renderTable();
    }

    async function sendEmailCore(task) {
        try {
            const params = { task_name: task.name, deadline: task.end, ref: task.ref, dept: task.dept, to_email: task.email };
            const res = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
            return res.status === 200;
        } catch (err) { return false; }
    }

    async function sendEmailManual(id) {
        const t = allTasks.find(x => x.id === id);
        if(confirm("G·ª≠i th∆∞ nh·∫Øc vi·ªác qu√° h·∫°n?")) {
            const success = await sendEmailCore(t);
            if (success) { t.alertSent = true; await silentSave(); renderTable(); alert("Th√†nh c√¥ng!"); }
        }
    }

    function addTask() {
        const n = document.getElementById('taskName').value, 
              d = document.getElementById('taskDept').value,
              s = document.getElementById('startDate').value, 
              e = document.getElementById('deadline').value,
              m = document.getElementById('emailRecipient').value;
        if(!n || !s || !e) return alert("Thi·∫øu th√¥ng tin!");

        const newTask = {
            id: Date.now().toString(),
            name: n, dept: d, email: m, start: s, end: e,
            iteration: document.getElementById('iterCount').value,
            ref: document.getElementById('taskRef').value,
            status: "ƒêang l√†m", alertSent: false,
            stt: allTasks.length + 1,
            createdAt: new Date().toISOString(),
            inputID: currentID 
        };
        allTasks.push(newTask);
        saveData();
        document.getElementById('taskName').value=''; document.getElementById('taskDept').value=''; 
        document.getElementById('taskRef').value=''; document.getElementById('emailRecipient').value='';
    }

    function renderTable() {
        const body = document.getElementById('taskBody');
        body.innerHTML = '';
        const now = new Date(); now.setHours(0,0,0,0);
        [...allTasks].reverse().forEach((t, index) => {
            const isOverdue = new Date(t.end) < now && t.status !== "Ho√†n th√†nh";
            const isDone = t.status === 'Ho√†n th√†nh';
            let statusColor = isDone ? '#2ecc71' : (t.status === 'Qu√° h·∫°n' ? '#ef476f' : '#4361ee');
            const sttDisplay = t.stt || (allTasks.length - index);
            const mailBg = t.alertSent ? "#94a3b8" : "var(--warning)";

            body.innerHTML += `
                <tr class="${isOverdue ? 'overdue-row' : ''}">
                    <td class="col-stt">${sttDisplay}</td>
                    <td class="col-1"><b>${t.name}</b><br><small>${t.dept || ''}</small></td>
                    <td class="col-2">${t.start}</td>
                    <td class="col-3" style="color:${isOverdue?'var(--danger)':'inherit'}">${t.end}</td>
                    <td class="col-4">${t.iteration}</td>
                    <td class="col-5">${t.ref || ''}</td>
                    <td class="col-6"><div class="progress-bg"><div class="progress-fill" style="width:${isDone?'100%':'50%'};background:${statusColor}"></div></div></td>
                    <td class="col-7"><span class="badge" style="background:${statusColor}">${t.status}</span></td>
                    <td class="col-8">
                        <button class="btn-sm" style="background:#2ecc71" onclick="confirmComplete('${t.id}')" ${isDone || t.status === 'Qu√° h·∫°n' ? 'disabled' : ''}><i class="fa-solid fa-check"></i></button>
                        ${isOverdue ? `<button class="btn-sm" style="background:${mailBg}; color:black" onclick="sendEmailManual('${t.id}')"><i class="fa-solid fa-envelope"></i></button>` : ''}
                        <button class="btn-sm" style="background:#ef476f" onclick="deleteTask('${t.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    function confirmComplete(id) { if(confirm("X√°c nh·∫≠n ho√†n th√†nh?")) { allTasks.find(x => x.id === id).status = "Ho√†n th√†nh"; saveData(); } }
    function deleteTask(id) { 
        const task = allTasks.find(x => x.id === id);
        if (!task) return;
        const now = new Date();
        const diffInHours = (now - new Date(task.createdAt)) / (1000 * 60 * 60);
        if (diffInHours > 24) { alert("Qu√° 24h kh√¥ng th·ªÉ x√≥a!"); return; }
        if(confirm("X√°c nh·∫≠n x√≥a?")) { allTasks = allTasks.filter(x => x.id !== id); saveData(); } 
    }
    window.onload = fetchData;
</script>
</body>
</html>
