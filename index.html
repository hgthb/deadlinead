<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ti·∫øn ƒê·ªô - Version A.12 (Full A.7 Logic)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4361ee; --danger: #ef476f; --success: #2ecc71; --warning: #f1c40f; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 5px 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box; color: var(--text); }

        /* B·∫¢O M·∫¨T: CH·∫æ ƒê·ªò READ-ONLY CHO M√ÅY TH·ª® 3 */
        body.is-readonly #adminForm, 
        body.is-readonly .col-8 button, 
        body.is-readonly .btn-sm { 
            pointer-events: none !important; 
            filter: grayscale(1) opacity(0.3) !important; 
            cursor: not-allowed !important;
        }
        body.is-readonly input { pointer-events: none !important; background-color: #f1f5f9 !important; }

        .container { max-width: 1450px; margin: auto; width: 100%; display: flex; flex-direction: column; height: 100%; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 15px; border-radius: 8px; margin-bottom: 5px; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* Layout c·ªßa b·∫£n A.7 */
        #adminForm { display: grid; grid-template-columns: 1.5fr 1fr 0.8fr 0.8fr 0.4fr 1.5fr 1.5fr 0.6fr; gap: 5px; background: #fff; padding: 8px; border-radius: 8px; margin-bottom: 5px; }

        input { height: 32px; padding: 0 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; outline: none; }
        .btn-add { height: 32px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 12px; }

        .main-content { background: white; border-radius: 8px; flex-grow: 1; overflow-y: auto; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { border-bottom: 1px solid #f1f5f9; font-size: 12px; height: 42px; padding: 0 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th { background: #f8fafc; color: #64748b; position: sticky; top: 0; text-align: left; z-index: 10; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; }

        .col-stt { width: 50px; text-align: center; }
        .col-1 { width: 28%; }
        .col-8 { width: 110px; text-align: right; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; color: #fff; font-weight: 700; display: inline-block; min-width: 85px; text-align: center; }
        .btn-sm { width: 28px; height: 28px; border: none; border-radius: 6px; cursor: pointer; color: white; margin-left: 5px; }
        #syncStatus { font-size: 10px; margin-left: 10px; color: var(--primary); font-weight: bold; }
        #deviceStatus { font-size: 10px; font-weight: 600; color: #94a3b8; }
    </style>
</head>
<body class="is-readonly">

<div class="container">
    <div class="top-bar">
        <div class="brand">üìã <b>PROJECT MANAGEMENT A.12</b> <span id="syncStatus"></span></div>
        <div id="deviceStatus"></div>
    </div>

    <div id="adminForm">
        <input type="text" id="taskName" placeholder="T√™n c√¥ng vi·ªác...">
        <input type="text" id="taskDept" placeholder="B·ªô ph·∫≠n...">
        <input type="date" id="startDate">
        <input type="date" id="deadline">
        <input type="number" id="iterCount" value="1" title="S·ªë l·∫ßn">
        <input type="text" id="taskRef" placeholder="Tham chi·∫øu...">
        <input type="text" id="emailRecipient" placeholder="Email nh·∫≠n th√¥ng b√°o...">
        <button class="btn-add" onclick="addTask()">TH√äM M·ªöI</button>
    </div>

    <div class="main-content">
        <table>
            <thead>
                <tr>
                    <th class="col-stt">STT</th>
                    <th class="col-1">Vi·ªác / B·ªô ph·∫≠n</th>
                    <th>B·∫Øt ƒë·∫ßu</th>
                    <th>H·∫°n ch√≥t</th>
                    <th style="width:50px">L·∫ßn</th>
                    <th>Tham chi·∫øu</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th class="col-8">Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
    // 1. KH·ªûI T·∫†O EMAILJS (Gi·ªØ nguy√™n logic A.7)
    emailjs.init("user_L49z9S6S6S6S6S6S"); 

    const BIN_ID = '6965ac34d0ea881f4067e559'; 
    const MASTER_KEY = '$2a$10$zN5MZaAsLugTkyNZA0ZHMu7CKiAktxDFCw1IGFEi4H46JOocrLTSy';
    const READ_KEY = '$2a$10$E020cSPDeHQd0G9ytrUj3u1YSFJN0d9sP3X0B38kOk.sZoVNqZn8K';
    const URL = "https://api.jsonbin.io/v3/b/" + BIN_ID;

    let allTasks = [];
    let whitelist = [];

    // 2. LOGIC B·∫¢O M·∫¨T V√ÇN TAY (Discussed Security)
    function getDeviceID() {
        const info = [navigator.userAgent, screen.width, navigator.language, navigator.hardwareConcurrency].join('|');
        let hash = 0;
        for (let i = 0; i < info.length; i++) {
            hash = ((hash << 5) - hash) + info.charCodeAt(i);
            hash |= 0;
        }
        return "ID-" + Math.abs(hash);
    }
    const currentID = getDeviceID();

    // 3. LOGIC RESET NG·∫¶M (CH·ªà M√ÅY 1)
    window.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.code === 'KeyR') {
            e.preventDefault();
            if (whitelist[0] === currentID) {
                const pass = prompt("H·ªÜ TH·ªêNG RESET - NH·∫¨P M·∫¨T M√É:");
                if (pass === "Hadmin123456$") {
                    if (confirm("Reset danh s√°ch thi·∫øt b·ªã?")) {
                        whitelist = [];
                        saveToCloud().then(() => location.reload());
                    }
                }
            }
        }
    });

    // 4. KH·ªûI T·∫†O D·ªÆ LI·ªÜU & KI·ªÇM TRA B·∫¢O M·∫¨T
    async function init() {
        try {
            const res = await fetch(URL, { headers: { 'X-Access-Key': READ_KEY, 'X-Bin-Meta': false } });
            const data = await res.json();
            allTasks = data.tasks || [];
            whitelist = data.whitelist || [];

            await silentSecurityCheck();
            renderTable();
            checkAndSendEmails(); // Logic A.7: T·ª± qu√©t khi m·ªü m√°y
        } catch (e) { document.getElementById('syncStatus').innerText = "‚úó L·ªói Data"; }
    }

    async function silentSecurityCheck() {
        const statusEl = document.getElementById('deviceStatus');
        if (whitelist.includes(currentID)) {
            document.body.classList.remove('is-readonly');
        } else if (whitelist.length < 2) {
            whitelist.push(currentID);
            await saveToCloud();
            document.body.classList.remove('is-readonly');
        } else {
            statusEl.innerText = "READ-ONLY MODE";
            document.body.classList.add('is-readonly');
        }
    }

    // 5. LOGIC EMAIL (Nguy√™n b·∫£n A.7)
    function sendEmailNotification(task, type = "NEW") {
        const templateParams = {
            to_email: task.email,
            task_name: task.name,
            deadline: task.end,
            status: type === "NEW" ? "M·ªöI ƒê∆Ø·ª¢C TH√äM" : "C·∫¢NH B√ÅO QU√Å H·∫†N"
        };
        emailjs.send('service_default', 'template_deadline', templateParams);
    }

    function checkAndSendEmails() {
        const today = new Date().toISOString().split('T')[0];
        allTasks.forEach(task => {
            if (task.status !== "Ho√†n th√†nh" && task.email && task.end <= today) {
                sendEmailNotification(task, "REMIND");
            }
        });
    }

    // 6. THAO T√ÅC D·ªÆ LI·ªÜU
    async function saveToCloud() {
        try {
            await fetch(URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
                body: JSON.stringify({ tasks: allTasks, whitelist: whitelist })
            });
            document.getElementById('syncStatus').innerText = "‚úì";
        } catch (e) { document.getElementById('syncStatus').innerText = "‚úó"; }
    }

    function renderTable() {
        const body = document.getElementById('taskBody');
        body.innerHTML = '';
        const today = new Date().toISOString().split('T')[0];

        [...allTasks].reverse().forEach((t) => {
            const isOverdue = t.status !== 'Ho√†n th√†nh' && t.end < today;
            const badgeColor = t.status === 'Ho√†n th√†nh' ? 'var(--success)' : (isOverdue ? 'var(--danger)' : 'var(--primary)');

            body.innerHTML += `
                <tr>
                    <td class="col-stt">${t.stt}</td>
                    <td class="col-1"><b>${t.name}</b><br><small style="color:#64748b">${t.dept || ''}</small></td>
                    <td>${t.start}</td>
                    <td>${t.end}</td>
                    <td style="text-align:center">${t.iteration}</td>
                    <td>${t.ref || '-'}</td>
                    <td><span class="badge" style="background:${badgeColor}">${t.status}</span></td>
                    <td class="col-8">
                        <button class="btn-sm" style="background:var(--success)" onclick="updateStatus('${t.id}')"><i class="fa-solid fa-check"></i></button>
                        <button class="btn-sm" style="background:var(--danger)" onclick="deleteTask('${t.id}')"><i class="fa-solid fa-trash-can"></i></button>
                    </td>
                </tr>`;
        });
    }

    function addTask() {
        const name = document.getElementById('taskName').value;
        const email = document.getElementById('emailRecipient').value;
        if(!name) return;

        const newTask = {
            id: Date.now().toString(),
            name: name,
            dept: document.getElementById('taskDept').value,
            start: document.getElementById('startDate').value,
            end: document.getElementById('deadline').value,
            iteration: document.getElementById('iterCount').value,
            ref: document.getElementById('taskRef').value,
            email: email,
            status: "ƒêang l√†m",
            stt: allTasks.length + 1
        };

        allTasks.push(newTask);
        if(email) sendEmailNotification(newTask, "NEW"); // G·ª≠i mail ngay khi th√™m
        saveToCloud();
        renderTable();
        document.getElementById('taskName').value = '';
    }

    function updateStatus(id) {
        const task = allTasks.find(t => t.id === id);
        if(task) { task.status = "Ho√†n th√†nh"; saveToCloud(); renderTable(); }
    }

    function deleteTask(id) {
        if(confirm("X√°c nh·∫≠n x√≥a?")) {
            allTasks = allTasks.filter(t => t.id !== id);
            saveToCloud();
            renderTable();
        }
    }

    window.onload = init;
</script>
</body>
</html>
