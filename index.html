<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deadline Manage - Version A.23 (Final Logic)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4361ee; --danger: #ef476f; --success: #2ecc71; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); margin: 0; padding: 5px 10px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box; color: var(--text); }

        /* Kh√≥a giao di·ªán khi kh√¥ng c√≥ quy·ªÅn Admin */
        body.is-readonly #adminForm, 
        body.is-readonly .col-8 button, 
        body.is-readonly .btn-sm { pointer-events: none !important; filter: grayscale(1) opacity(0.3) !important; }
        body.is-readonly input { pointer-events: none !important; background-color: #f1f5f9 !important; }

        .container { max-width: 1450px; margin: auto; width: 100%; display: flex; flex-direction: column; height: 100%; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 15px; border-radius: 8px; margin-bottom: 5px; flex-shrink: 0; }
        #adminForm { display: grid; grid-template-columns: 1.5fr 1fr 0.8fr 0.8fr 0.4fr 1.5fr 1.5fr 0.6fr; gap: 5px; background: #fff; padding: 8px; border-radius: 8px; margin-bottom: 5px; }
        input { height: 32px; padding: 0 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; outline: none; }
        .btn-add { height: 32px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 12px; }
        .main-content { background: white; border-radius: 8px; flex-grow: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #f1f5f9; font-size: 12px; height: 42px; padding: 0 12px; }
        th { background: #f8fafc; color: #64748b; position: sticky; top: 0; text-align: left; z-index: 10; text-transform: uppercase; }
        .col-stt { width: 40px; text-align: center; }
        .col-8 { width: 100px; text-align: right; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; color: #fff; font-weight: 700; display: inline-block; min-width: 80px; text-align: center; }
        .btn-sm { width: 28px; height: 28px; border: none; border-radius: 6px; cursor: pointer; color: white; margin-left: 5px; }
        #deviceStatus { font-size: 10px; font-weight: 600; color: #94a3b8; }
    </style>
</head>
<body class="is-readonly">

<div class="container">
    <div class="top-bar">
        <div class="brand">üìã <b>PROJECT A.23</b> <span id="syncStatus" style="font-size: 10px; margin-left:10px; color: var(--primary);"></span></div>
        <div id="deviceStatus">X√°c th·ª±c...</div>
    </div>

    <div id="adminForm">
        <input type="text" id="taskName" placeholder="Vi·ªác...">
        <input type="text" id="taskDept" placeholder="Ng∆∞·ªùi x·ª≠ l√Ω...">
        <input type="date" id="startDate">
        <input type="date" id="deadline">
        <input type="number" id="iterCount" value="1">
        <input type="text" id="taskRef" placeholder="Tham chi·∫øu...">
        <input type="text" id="emailRecipient" placeholder="Email...">
        <button class="btn-add" onclick="addTask()">TH√äM</button>
    </div>

    <div class="main-content">
        <table>
            <thead>
                <tr>
                    <th class="col-stt">STT</th>
                    <th>N·ªôi dung</th>
                    <th>B·∫Øt ƒë·∫ßu</th>
                    <th>H·∫°n ch√≥t</th>
                    <th>L·∫ßn</th>
                    <th>Status</th>
                    <th class="col-8">S·ª≠a/X√≥a</th>
                </tr>
            </thead>
            <tbody id="taskBody"></tbody>
        </table>
    </div>
</div>

<script>
    const BIN_ID = '6965ac34d0ea881f4067e559'; 
    const MASTER_KEY = '$2a$10$zN5MZaAsLugTkyNZA0ZHMu7CKiAktxDFCw1IGFEi4H46JOocrLTSy';
    const READ_KEY = '$2a$10$E020cSPDeHQd0G9ytrUj3u1YSFJN0d9sP3X0B38kOk.sZoVNqZn8K';
    const URL = "https://api.jsonbin.io/v3/b/" + BIN_ID;

    let allTasks = [];
    let whitelist = [];

    function getDeviceID() {
        const info = [navigator.userAgent, screen.width, navigator.language].join('|');
        let hash = 0;
        for (let i = 0; i < info.length; i++) {
            hash = ((hash << 5) - hash) + info.charCodeAt(i);
            hash |= 0;
        }
        return "ID-" + Math.abs(hash);
    }
    const currentID = getDeviceID();

    // RESET QUY·ªÄN: CH·ªà CH·∫§P NH·∫¨N T·ª™ M√ÅY ID1
    window.addEventListener('keydown', e => {
        if (e.ctrlKey && e.shiftKey && e.code === 'KeyR') {
            e.preventDefault();
            // Ki·ªÉm tra m√°y hi·ªán t·∫°i c√≥ ph·∫£i m√°y ƒë·∫ßu ti√™n trong danh s√°ch kh√¥ng
            if (whitelist.length > 0 && whitelist[0] === currentID) {
                const pass = prompt("X√ÅC NH·∫¨N M·∫¨T M√É RESET WHITELIST:");
                if (pass === "Hadmin123456$") {
                    whitelist = []; 
                    saveToCloud().then(() => {
                        alert("ƒê√£ reset to√†n b·ªô danh s√°ch thi·∫øt b·ªã!");
                        location.reload();
                    });
                } else if (pass !== null) alert("M·∫≠t m√£ kh√¥ng ƒë√∫ng.");
            } else {
                console.warn("Ch·ªâ m√°y ch·ªß (ID1) m·ªõi c√≥ quy·ªÅn Reset.");
            }
        }
    });

    async function init() {
        try {
            const res = await fetch(URL, { headers: { 'X-Access-Key': READ_KEY, 'X-Bin-Meta': false } });
            const data = await res.json();
            allTasks = data.tasks || [];
            whitelist = data.whitelist || [];
            checkSecurity();
            renderTable();
        } catch (e) { document.getElementById('deviceStatus').innerText = "L·ªñI K·∫æT N·ªêI"; }
    }

    function checkSecurity() {
        const statusEl = document.getElementById('deviceStatus');
        
        // N·∫øu ID m√°y hi·ªán t·∫°i c√≥ trong whitelist (b·∫•t k·ªÉ v·ªã tr√≠ 1 hay 2)
        if (whitelist.includes(currentID)) {
            document.body.classList.remove('is-readonly');
            statusEl.innerText = "ADMIN MODE (ID " + (whitelist.indexOf(currentID)+1) + ")";
        } 
        // N·∫øu ch∆∞a ƒë·ªß 2 m√°y, t·ª± ƒë·ªông c·∫•p quy·ªÅn Admin cho m√°y m·ªõi
        else if (whitelist.length < 2) {
            whitelist.push(currentID);
            saveToCloud();
            document.body.classList.remove('is-readonly');
            statusEl.innerText = "ADMIN MODE (ƒê√É ƒêƒÇNG K√ù)";
        } 
        // ƒê√£ ƒë·ªß 2 m√°y v√† ID m√°y n√†y kh√¥ng tr√πng, chuy·ªÉn sang ch·∫ø ƒë·ªô Ch·ªâ xem
        else {
            document.body.classList.add('is-readonly');
            statusEl.innerText = "READ ONLY (ID: " + currentID + ")";
        }
    }

    async function saveToCloud() {
        await fetch(URL, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'X-Master-Key': MASTER_KEY },
            body: JSON.stringify({ tasks: allTasks, whitelist: whitelist })
        });
        document.getElementById('syncStatus').innerText = "‚úì";
    }

    function renderTable() {
        const body = document.getElementById('taskBody');
        body.innerHTML = '';
        [...allTasks].reverse().forEach(t => {
            body.innerHTML += `<tr>
                <td class="col-stt">${t.stt}</td>
                <td><b>${t.name}</b><br><small>${t.dept || ''}</small></td>
                <td>${t.start}</td><td>${t.end}</td><td>${t.iteration}</td>
                <td><span class="badge" style="background:${t.status==='Ho√†n th√†nh'?'#2ecc71':'#4361ee'}">${t.status}</span></td>
                <td class="col-8">
                    <button class="btn-sm" style="background:#2ecc71" onclick="updateStatus('${t.id}')"><i class="fa-solid fa-check"></i></button>
                    <button class="btn-sm" style="background:#ef476f" onclick="deleteTask('${t.id}')"><i class="fa-solid fa-trash-can"></i></button>
                </td>
            </tr>`;
        });
    }

    function addTask() {
        const name = document.getElementById('taskName').value;
        if(!name) return;
        allTasks.push({ id: Date.now().toString(), name, dept: document.getElementById('taskDept').value, start: document.getElementById('startDate').value, end: document.getElementById('deadline').value, iteration: document.getElementById('iterCount').value, status: "ƒêang l√†m", stt: allTasks.length + 1 });
        saveToCloud(); renderTable();
        document.getElementById('taskName').value = '';
    }

    function updateStatus(id) { 
        const task = allTasks.find(t => t.id === id);
        if(task) { task.status = "Ho√†n th√†nh"; saveToCloud(); renderTable(); }
    }
    
    function deleteTask(id) { 
        if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?")) { 
            allTasks = allTasks.filter(t => t.id !== id); 
            saveToCloud(); renderTable(); 
        } 
    }

    window.onload = init;
</script>
</body>
</html>
